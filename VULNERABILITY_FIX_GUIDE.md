# 🚨 Vulnerability Fix Guide - Quay.io Security Issues

This guide helps you resolve the 7 vulnerabilities detected by Quay Security Scanner.

## 🔍 Current Vulnerabilities

The vulnerabilities you're seeing are:

| Package | Current | Fixed | Source |
|---------|---------|-------|---------|
| **urllib3** | 2.3.0 | 2.5.0 | Python package |
| **github.com/go-viper/mapstructure/v2** | v2.2.1 | 2.3.0 | toolbox package |
| **stdlib** | go1.24.3 | 1.24.4 | toolbox package |

**Root cause**: The `toolbox` package contains vulnerable Go dependencies that are hard to remove.

## 🛠️ Step-by-Step Fix

### Step 1: Verify Current Image
```bash
# Check which image is currently in registry
sudo podman pull quay.io/rh-ee-jkryhut/fedora-bootc-hass:latest
sudo podman inspect quay.io/rh-ee-jkryhut/fedora-bootc-hass:latest | grep -A5 "Created"

# Check layers
sudo podman history quay.io/rh-ee-jkryhut/fedora-bootc-hass:latest
```

### Step 2: Force Ultra-Security Build
```bash
# Clean local images first
sudo podman rmi quay.io/rh-ee-jkryhut/fedora-bootc-hass:latest || true

# Ultra-aggressive security build
sudo make build-ultra-security

# OR standard security build with force refresh
sudo make build-security
```

### Step 3: Verify Local Fix
```bash
# Check if vulnerable packages are still present
sudo podman run --rm quay.io/rh-ee-jkryhut/fedora-bootc-hass:latest rpm -qa | grep toolbox
sudo podman run --rm quay.io/rh-ee-jkryhut/fedora-bootc-hass:latest rpm -qa | grep golang
sudo podman run --rm quay.io/rh-ee-jkryhut/fedora-bootc-hass:latest python3 -c "import urllib3; print(urllib3.__version__)"
```

### Step 4: Push Updated Image
```bash
# Login to registry (if not already)
sudo podman login quay.io

# Push the fixed image
sudo make push

# Verify push completed
sudo podman push quay.io/rh-ee-jkryhut/fedora-bootc-hass:latest
```

### Step 5: Force Registry Rescan
1. Go to https://quay.io/repository/rh-ee-jkryhut/fedora-bootc-hass
2. Click on **"Tags"** tab
3. Find the `latest` tag
4. Click **"Rescan"** button (if available)
5. Wait 5-10 minutes for new scan results

## 🔧 Troubleshooting

### Issue: "Same vulnerabilities still showing"

**Possible causes:**
1. **Old image cached** - registry still showing old scan
2. **Build didn't use latest base** - base image wasn't updated
3. **Packages reinstalled** - dependencies pulled vulnerable packages back

**Solutions:**
```bash
# Force complete rebuild
sudo podman system prune -a -f
sudo make build-security
sudo make push

# Check build logs for errors
sudo podman build --no-cache --pull=always -t test-security . 2>&1 | grep -i error
```

### Issue: "urllib3 still old version"

**Diagnostic:**
```bash
# Check what's installing urllib3
sudo podman run --rm quay.io/rh-ee-jkryhut/fedora-bootc-hass:latest \
  rpm -q --whatrequires python3-urllib3
```

**Fix:**
```bash
# Force specific version
echo "RUN pip3 install --force-reinstall urllib3==2.5.0" >> Containerfile.security
sudo podman build -f Containerfile.security -t fixed-image .
```

### Issue: "toolbox still present"

**Diagnostic:**
```bash
# Check if toolbox was actually removed
sudo podman run --rm quay.io/rh-ee-jkryhut/fedora-bootc-hass:latest \
  rpm -qa | grep -E "(toolbox|golang)" || echo "Packages successfully removed"
```

**Nuclear option:**
```dockerfile
# Add to end of Containerfile
RUN rpm -e --nodeps $(rpm -qa | grep -E "(toolbox|golang|container-tools)") || true
RUN rm -rf /usr/bin/toolbox /usr/share/toolbox || true
```

## 🚀 Alternative: Ultra-Clean Build

If regular fixes don't work, use the nuclear option:

### 1. Create Clean Containerfile
```bash
# Backup current
cp Containerfile Containerfile.backup

# Use ultra-clean approach
cat > Containerfile.clean << 'EOF'
FROM quay.io/fedora/fedora-bootc:42 as ansible-stage
RUN dnf -y install linux-system-roles
RUN mkdir -p /deps
COPY bindep.txt /deps/
RUN /usr/share/ansible/collections/ansible_collections/fedora/linux_system_roles/roles/podman/.ostree/get_ostree_data.sh packages runtime fedora-42 raw >> /deps/bindep.txt || true

FROM quay.io/fedora/fedora-bootc:42

# NUCLEAR SECURITY: Remove ALL vulnerable packages first
RUN dnf -y remove toolbox golang golang-* container-tools buildah skopeo || true

# Upgrade everything
RUN dnf -y upgrade --refresh

# Install only essential packages
RUN --mount=type=bind,from=ansible-stage,source=/deps/,target=/deps \
    grep -v '^#' /deps/bindep.txt | grep -v toolbox | grep -v golang | xargs dnf -y install

# Install urllib3 from pip (latest version)
RUN pip3 install --upgrade urllib3==2.5.0

# Continue with rest of your config...
EOF
```

### 2. Build with Clean File
```bash
sudo podman build -f Containerfile.clean --no-cache --pull=always \
  -t quay.io/rh-ee-jkryhut/fedora-bootc-hass:clean .
```

### 3. Test and Push
```bash
# Test the clean image
sudo podman run --rm quay.io/rh-ee-jkryhut/fedora-bootc-hass:clean \
  python3 -c "import urllib3; print('urllib3:', urllib3.__version__)"

# If good, push it
sudo podman push quay.io/rh-ee-jkryhut/fedora-bootc-hass:clean
```

## 📊 Verification Checklist

After build and push, verify:

- [ ] **Local check**: `sudo podman run --rm IMAGE rpm -qa | grep toolbox` returns nothing
- [ ] **urllib3 version**: `sudo podman run --rm IMAGE python3 -c "import urllib3; print(urllib3.__version__)"` shows ≥2.5.0
- [ ] **No golang**: `sudo podman run --rm IMAGE rpm -qa | grep golang` returns nothing  
- [ ] **Registry updated**: Check Quay.io shows new image timestamp
- [ ] **Security scan**: Wait 10-15 minutes for new scan results

## 🔄 Quick Commands Summary

```bash
# The nuclear option - guaranteed fix
sudo podman rmi quay.io/rh-ee-jkryhut/fedora-bootc-hass:latest || true
sudo make build-ultra-security  
sudo make push

# Wait 10-15 minutes, then check Quay.io security scan
```

## 📞 If Still Not Working

1. **Check registry timing**: Quay.io scans can take 15-30 minutes to update
2. **Verify image timestamp**: Make sure Quay.io shows recent push time
3. **Manual rescan**: Look for "Rescan" button in Quay.io interface
4. **Contact support**: If registry scan is stuck, contact Quay.io support

The key is ensuring your new image actually replaces the old one in the registry! 🔒