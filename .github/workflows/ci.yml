name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  REGISTRY: quay.io  # ZmÄ›Åˆte na docker.io, ghcr.io, nebo jinÃ½ registry
  IMAGE_NAME: ${{ github.repository_owner }}/fedora-bootc-hass
  PODMAN_VERSION: latest

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up test environment
      run: |
        sudo apt-get update
        sudo apt-get install -y bash shellcheck jq

    - name: Make scripts executable
      run: |
        find scripts -name "*.sh" -type f -exec chmod +x {} \;
        find tests -name "*.sh" -type f -exec chmod +x {} \;

    - name: Run shellcheck
      run: |
        find scripts -name "*.sh" -type f -print0 | xargs -0 shellcheck -x || true

    - name: Run unit tests
      run: make test-scripts

    - name: Run integration tests
      run: make test-integration

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          tests/results/
          performance_results/

  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Validate TOML configs
      run: |
        # Install toml library for validation
        pip install toml
        
        # Validate all TOML files
        for file in *.toml; do
          if [[ -f "$file" ]]; then
            echo "Validating $file..."
            python -c "import toml; import sys; toml.load(open('$file')); print('âœ“ $file is valid TOML')" || exit 1
          fi
        done

    - name: Check Containerfile syntax
      run: |
        # Basic syntax validation
        grep -E '^FROM|^RUN|^COPY|^LABEL' Containerfile > /dev/null || exit 1
        echo "Containerfile syntax appears valid"

  build:
    name: Build Container Image
    runs-on: ubuntu-latest
    needs: [test, validate]
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Podman
      run: |
        sudo apt-get update
        sudo apt-get -y install podman

    - name: Log in to Registry
      if: github.event_name != 'pull_request' && vars.ENABLE_REGISTRY_PUSH == 'true'
      env:
        QUAY_USERNAME: ${{ secrets.QUAY_USERNAME }}
        QUAY_PASSWORD: ${{ secrets.QUAY_PASSWORD }}
      run: |
        if [ -n "$QUAY_USERNAME" ] && [ -n "$QUAY_PASSWORD" ]; then
          echo "$QUAY_PASSWORD" | podman login ${{ env.REGISTRY }} \
            --username "$QUAY_USERNAME" \
            --password-stdin
        else
          echo "Registry credentials not available, skipping login"
          exit 0
        fi

    - name: Set up build metadata
      id: meta
      run: |
        # Generate version tag
        if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
          VERSION="latest"
        elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
          VERSION="develop"
        else
          VERSION="pr-${{ github.event.pull_request.number }}"
        fi
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "build_date=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT
        echo "commit_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

    - name: Build container image
      id: build
      run: |
        echo "Building container image..."
        
        # Build with both registry and local tags for flexibility
        if podman build \
          --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }} \
          --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.commit_sha }} \
          --tag ci-build-image:latest \
          --label "org.opencontainers.image.created=${{ steps.meta.outputs.build_date }}" \
          --label "org.opencontainers.image.revision=${{ github.sha }}" \
          --label "org.opencontainers.image.version=${{ steps.meta.outputs.version }}" \
          .; then
          echo "âœ… Container image built successfully"
          echo "build_success=true" >> $GITHUB_OUTPUT
          
          # Show available images for debugging
          echo "Available images:"
          podman images | grep -E "(ci-build|fedora-bootc-hass)" || true
        else
          echo "âŒ Container image build failed"
          echo "build_success=false" >> $GITHUB_OUTPUT
          exit 1
        fi

    - name: Run security scan
      if: steps.build.outputs.build_success == 'true'
      run: |
        echo "ðŸ” Running security scan on built image..."
        
        # Install trivy
        sudo apt-get update
        sudo apt-get install -y wget apt-transport-https gnupg lsb-release
        wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
        echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
        sudo apt-get update
        sudo apt-get install -y trivy
        
        # Determine which image to scan
        SCAN_IMAGE="ci-build-image:latest"
        
        # Verify image exists
        if ! podman inspect "$SCAN_IMAGE" >/dev/null 2>&1; then
          echo "âš ï¸  Built image not found, trying registry tag..."
          SCAN_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}"
          
          if ! podman inspect "$SCAN_IMAGE" >/dev/null 2>&1; then
            echo "âŒ No suitable image found for scanning"
            echo "Available images:"
            podman images
            exit 1
          fi
        fi
        
        echo "Scanning image: $SCAN_IMAGE"
        
        # Scan image with error handling
        trivy image \
          --exit-code 0 \
          --severity HIGH,CRITICAL \
          --format table \
          "$SCAN_IMAGE" || {
          echo "âš ï¸  Security scan completed with findings"
          echo "Note: This is a basic scan. For comprehensive analysis, see Security Monitoring workflow"
        }
        
        echo "âœ… Security scan completed"

    - name: Push image
      if: github.event_name != 'pull_request' && success() && vars.ENABLE_REGISTRY_PUSH == 'true'
      env:
        QUAY_USERNAME: ${{ secrets.QUAY_USERNAME }}
        QUAY_PASSWORD: ${{ secrets.QUAY_PASSWORD }}
      run: |
        if [ -n "$QUAY_USERNAME" ] && [ -n "$QUAY_PASSWORD" ]; then
          podman push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}
          podman push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.commit_sha }}
        else
          echo "Registry credentials not available, skipping push"
          exit 0
        fi

  build-artifacts:
    name: Build Deployment Artifacts
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name != 'pull_request'
    strategy:
      matrix:
        artifact: [qcow2, iso]
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get -y install podman qemu-utils

    - name: Build ${{ matrix.artifact }}
      run: |
        # This would require bootc-image-builder
        echo "Building ${{ matrix.artifact }} artifact..."
        # make ${{ matrix.artifact }}

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact }}-image
        path: output/${{ matrix.artifact }}/*
        retention-days: 7

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build, build-artifacts]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Generate changelog
      id: changelog
      run: |
        # Simple changelog generation
        echo "## Changes in this release" > CHANGELOG_TEMP.md
        echo "" >> CHANGELOG_TEMP.md
        git log --pretty=format:"- %s (%h)" -10 >> CHANGELOG_TEMP.md
        
        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        cat CHANGELOG_TEMP.md >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}
        name: Release v${{ github.run_number }}
        body: ${{ steps.changelog.outputs.changelog }}
        draft: false
        prerelease: false
        files: |
          output/**/*